<script>
let allPosts = [];
let loadedFiles = [];
let allFiles = [];
let loadBatch = 10;
let filtersActive = false; // pause infinite scroll while filtering

// Create the observer globally
let observer = new IntersectionObserver(entries => {
  if (filtersActive) return; // completely ignore while filtering
  entries.forEach(entry => {
    if (entry.isIntersecting) loadPostsBatch();
  });
}, { rootMargin: "300px" });

async function loadPostsBatch() {
  if (loadPostsBatch.loading || filtersActive) return; // guard while filtering
  loadPostsBatch.loading = true;

  try {
    if (!allFiles.length) {
      const indexRes = await fetch(`output/metadata/index.json?t=${Date.now()}`, { cache: "no-store" });
      if (!indexRes.ok) throw new Error("Index fetch failed");
      allFiles = (await indexRes.json()).sort().reverse();
    }

    const nextFiles = allFiles.slice(loadedFiles.length, loadedFiles.length + loadBatch);
    if (!nextFiles.length) {
      loadPostsBatch.loading = false;
      return;
    }

    const requests = nextFiles.map(file =>
      fetch(`output/metadata/${file}?t=${Date.now()}`, { cache: "no-store" })
        .then(r => {
          if (!r.ok) throw new Error(file + " failed");
          return r.json();
        })
        .then(daily => ({ file, daily }))
    );

    const results = await Promise.all(requests);

    results.forEach(({ file, daily }) => {
      const dateMatch = file.match(/\d{4}-\d{2}-\d{2}/);
      const date = dateMatch ? dateMatch[0] : '';

      daily.forEach(p => {
        allPosts.push({
          date,
          text: p.tweet_text || "",
          images: p.images || [],
          url: p.tweet_url || "",
          hashtags: extractHashtags(p.tweet_text || ""),
          type: p.type || ""
        });
      });

      loadedFiles.push(file);
    });

    allPosts.sort((a, b) => b.date.localeCompare(a.date));

    renderLimited(allPosts);
  } catch (err) {
    console.error("SPXVisuals load error:", err);
    document.getElementById("posts").innerHTML =
      "<p style='text-align:center'>‚ö†Ô∏è Data failed to load.</p>";
  }

  loadPostsBatch.loading = false;
}

function extractHashtags(text) {
  if (!text) return [];
  const tagMatches = text.match(/#[A-Za-z0-9_]+/g) || [];
  const cashMatches = text.match(/\$[A-Za-z0-9_]+/g) || [];
  return [...new Set([...tagMatches, ...cashMatches])];
}

function stripHashtags(text) {
  if (!text) return "";
  return text
    .replace(/#[A-Za-z0-9_]+/g, '')
    .replace(/\$[A-Za-z0-9_]+/g, '')
    .replace(/\s{2,}/g, ' ')
    .trim();
}

function todayLocalISO() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}

function normalizeDateInput(input) {
  const match = input.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (!match) return input;
  const [, mm, dd, yyyy] = match;
  return `${yyyy}-${mm}-${dd}`;
}

function renderPosts(posts) {
  const container = document.getElementById('posts');
  container.innerHTML = '';

  if (!posts.length) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'No charts match your filters üìâ';
    container.appendChild(empty);
    return;
  }

  posts.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';

    div.innerHTML = `
      ${post.url ? `<div class="tweet-link-container"><a href="${post.url}" target="_blank">See Post On ùïè</a></div>` : ''}
      <div class="post-date">${post.date}</div>
      <div class="post-text">${stripHashtags(post.text)}</div>
      <div class="hashtags">
        ${post.hashtags.map(t => `<a href="#">${t}</a>`).join('')}
      </div>
      ${post.images.map((i, idx) => {
        const eager = idx < 4; // first 4 images eager
        return `<img src="${i}" loading="${eager ? 'eager' : 'lazy'}" decoding="async" fetchpriority="${eager ? 'high' : 'low'}">`;
      }).join('')}
    `;

    div.querySelectorAll('.hashtags a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('search').value = a.textContent;
        applyFilters();
      });
    });

    container.appendChild(div);
  });

  waitForImages().then(() => requestAnimationFrame(() => requestAnimationFrame(applyMasonry)));
  enableImageZoom();
}

function renderLimited(posts) {
  renderPosts(posts);

  let sentinel = document.getElementById('scrollSentinel');

  if (!sentinel) {
    sentinel = document.createElement('div');
    sentinel.id = 'scrollSentinel';
    sentinel.style.height = '80px';
    sentinel.style.margin = '80px 0';
    document.body.appendChild(sentinel);
    observer.observe(sentinel);
  }

  sentinel.style.display = loadedFiles.length >= allFiles.length ? 'none' : 'block';
}

const filters = { today: false, week: false, month: false };

function waitForImages() {
  const imgs = document.querySelectorAll('#posts img');
  return Promise.all([...imgs].map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(res => { img.onload = img.onerror = res; });
  }));
}

function updateButtons() {
  todayBtn.classList.toggle('active', filters.today);
  weekBtn.classList.toggle('active', filters.week);
  monthBtn.classList.toggle('active', filters.month);

  const searchValue = document.getElementById('search').value;
  clearBtn.style.display =
    (filters.today || filters.week || filters.month || searchValue)
      ? 'inline-block'
      : 'none';
}

function applyFilters() {
  filtersActive = true; // pause infinite scroll

  let input = normalizeDateInput(
    document.getElementById('search').value.toLowerCase()
  );

  let filtered = allPosts.filter(post =>
    post.hashtags.some(t => t.toLowerCase().includes(input)) ||
    post.date.includes(input)
  );

  const now = new Date(todayLocalISO());

  if (filters.today) {
    filtered = filtered.filter(p => p.date === todayLocalISO());
  } else if (filters.week) {
    const d = new Date(now);
    d.setDate(now.getDate() - 7);
    filtered = filtered.filter(p => new Date(p.date) >= d);
  } else if (filters.month) {
    const d = new Date(now);
    d.setMonth(now.getMonth() - 1);
    filtered = filtered.filter(p => new Date(p.date) >= d);
  }

  renderPosts(filtered);
  updateButtons();

  observer.disconnect(); // stop all infinite scroll triggers while filtering
}

document.getElementById('search').addEventListener('input', applyFilters);

const todayBtn = document.getElementById('todayFilter');
const weekBtn = document.getElementById('weekFilter');
const monthBtn = document.getElementById('monthFilter');
const clearBtn = document.getElementById('clearSearch');

todayBtn.onclick = () => {
  filters.today = !filters.today;
  filters.week = filters.month = false;
  applyFilters();
};

weekBtn.onclick = () => {
  filters.week = !filters.week;
  filters.today = filters.month = false;
  applyFilters();
};

monthBtn.onclick = () => {
  filters.month = !filters.month;
  filters.today = filters.week = false;
  applyFilters();
};

clearBtn.onclick = () => {
  document.getElementById('search').value = '';
  filters.today = filters.week = filters.month = false;
  filtersActive = false; // resume infinite scroll
  renderLimited(allPosts);
  observer.observe(document.getElementById('scrollSentinel')); // reconnect observer
  updateButtons();
};

function applyMasonry() {
  const container = document.getElementById('posts');
  const items = [...container.children];
  if (!items.length) return;

  const cols = window.innerWidth < 768 ? 1 : 2;
  const gap = 32;
  const colHeights = Array(cols).fill(0);
  const colWidth = (container.clientWidth - gap) / cols;

  container.style.position = 'relative';

  items.forEach(item => {
    item.style.position = 'absolute';
    item.style.width = colWidth + 'px';

    const minCol = colHeights.indexOf(Math.min(...colHeights));
    let x = minCol * (colWidth + gap);
    if (cols === 1) x = (container.clientWidth - colWidth) / 2;
    const y = colHeights[minCol];

    item.style.transform = `translate(${x}px, ${y}px)`;
    colHeights[minCol] += item.offsetHeight + gap;
  });

  container.style.height = Math.max(...colHeights) + 'px';
}

window.addEventListener('resize', () => {
  requestAnimationFrame(applyMasonry);
});

document.getElementById('posts').addEventListener('load', e => {
  if (e.target.tagName === 'IMG') {
    requestAnimationFrame(() => requestAnimationFrame(applyMasonry));
  }
}, true);

function enableImageZoom() {
  document.querySelectorAll('#posts img').forEach(img => {
    img.addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      const big = document.createElement('img');
      big.src = img.src;
      modal.appendChild(big);
      document.body.appendChild(modal);
      modal.addEventListener('click', () => modal.remove());
    });
  });
}

// INITIAL LOAD
loadPostsBatch();
</script>
