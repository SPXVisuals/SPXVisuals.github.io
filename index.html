<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SPXVisuals</title>

<style>
body {
font-family: system-ui, sans-serif;
background: #0f172a;
color: #e5e7eb;
margin: 0;
padding: 24px;
}

a { text-decoration: none; color: inherit; }

/* ---------------- Header ---------------- */
header {
position: sticky;
top: 0;
z-index: 100;
padding: 16px 24px;
display: flex;
flex-direction: column;
align-items: center;
gap: 10px;
background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6);
background-size: 200% 200%;
animation: gradientShift 6s ease infinite;
color: #ffffff;
position: relative;
}

.header-watermark {
position: absolute;
bottom: 4px;
left: 8px;
font-size: 0.65rem;
opacity: .55;
pointer-events: none;
}

.header-copyright {
position: absolute;
bottom: 4px;
right: 8px;
font-size: 0.65rem;
opacity: .55;
pointer-events: none;
}

@media (max-width:768px){
  .header-watermark,
  .header-copyright {
    font-size: 0.45rem;
    opacity: 0.55;
  }

  .header-watermark {
    left: 6px;
    bottom: 2px;
  }

  .header-copyright {
    right: 6px;
    bottom: 2px;
  }
}
  
h1 {
margin: 0;
font-size: 2rem;
display: flex;
align-items: center;
gap: 12px;
}

.title-link,.x-link { color:#fff; cursor:pointer; }
.title-link:hover,.x-link:hover { text-decoration:underline; }

.controls {
display:flex;
flex-direction:column;
gap:10px;
width:100%;
max-width:420px;
align-items:center;
}

input[type="text"] {
padding:6px 12px;
border-radius:6px;
border:1px solid #475569;
background:#020617;
color:#e5e7eb;
width:100%;
max-width:360px;
text-align:center;
}

.filter-buttons {
display:flex;
gap:8px;
flex-wrap:wrap;
justify-content:center;
}

button {
background:#020617;
color:#e5e7eb;
border:none;
border-radius:6px;
padding:6px 12px;
cursor:pointer;
transition:.3s;
}

button:hover { background:#1e293b; }

button.active {
background:#fff;
color:#020617;
}

#clearSearch {
background:#111827;
display:none;
}

/* ---------------- Layout ---------------- */
main {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-auto-flow: dense;
  gap: 32px;
  margin-top: 32px;
}


.post {
  display: block;
  width: 100%;
  break-inside: avoid;
  background: transparent;
  padding: 0;
  transition: transform 0.35s ease, filter 0.35s ease;
}

.post img {
width:100%;
border-radius:10px;
margin:16px 0;
cursor:zoom-in;
transition:.3s;
image-rendering: auto;
backface-visibility: hidden;
transform: translateZ(0);
will-change: transform;
}

.post-text {
  text-align: center;
  font-weight: 600;
  font-size: 1rem;
}
  
.hashtags { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin:.5rem;}

.hashtags a {
font-size:.85rem;
color:#22d3ee;
}

.post-date {
font-size:.8rem;
color:#94a3b8;
margin-bottom:6px;
}

.tweet-link-container { text-align:center; margin-bottom:8px; }

.tweet-link-container a {
display:inline-block;
background:linear-gradient(90deg,#3b82f6,#06b6d4,#3b82f6);
background-size:200% 200%;
padding:6px 10px;
border-radius:8px;
font-weight:bold;
color:#fff;
animation:gradientShift 3s ease infinite;
}

.tweet-link-container a:hover {
  transform: scale(1.08);
}

.image-modal {
position:fixed;
inset:0;
background:rgba(0,0,0,.85);
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
}

.image-modal img {
max-width:95%;
max-height:95%;
border-radius:12px;
cursor:zoom-out;
}

@keyframes gradientShift {
0%{background-position:0% 50%}
50%{background-position:100% 50%}
100%{background-position:0% 50%}
}

@media (max-width:768px){
main{column-count:1;}
}
</style>
</head>

<body>
<header>
<div class="header-watermark">SPXVisuals ‚Ä¢ x.com/SPXVisuals</div>
<div class="header-copyright">¬© 2026 SPXVisuals ‚Ä¢ All Rights Reserved</div>

<h1>
üìä <a>SPXVisuals</a> üìà
</h1>

<a href="https://x.com/SPXVisuals" class="x-link">ùïè</a>

<div class="controls">
<input type="text" id="search" placeholder="Search by hashtag or YYYY-MM-DD" />
<div class="filter-buttons">
<button id="todayFilter">Today's Charts</button>
<button id="weekFilter">This Week</button>
<button id="monthFilter">This Month</button>
<button id="clearSearch">Clear Search</button>
</div>
</div>
</header>

<main id="posts"></main>

<footer style="text-align:center;margin-top:48px;font-size:.8rem;color:#94a3b8;">
¬© 2026 SPXVisuals ‚Ä¢ All Rights Reserved<br>
For Educational Purposes Only
</footer>

<script>
let allPosts = [];
let loadedFiles = [];
let allFiles = [];
let loadBatch = 10;
let filtersActive = false; // pause infinite scroll while filtering

// Create the observer globally
let observer = new IntersectionObserver(entries => {
  if (filtersActive) return; // ignore while filtering
  entries.forEach(entry => {
    if (entry.isIntersecting) loadPostsBatch();
  });
}, { rootMargin: "300px" });

// Load posts in batches for infinite scroll
async function loadPostsBatch() {
  if (loadPostsBatch.loading || filtersActive) return;
  loadPostsBatch.loading = true;

  try {
    if (!allFiles.length) {
      const indexRes = await fetch(`output/metadata/index.json?t=${Date.now()}`, { cache: "no-store" });
      if (!indexRes.ok) throw new Error("Index fetch failed");
      allFiles = (await indexRes.json()).sort().reverse();
    }

    const nextFiles = allFiles.slice(loadedFiles.length, loadedFiles.length + loadBatch);
    if (!nextFiles.length) {
      loadPostsBatch.loading = false;
      return;
    }

    const requests = nextFiles.map(file =>
      fetch(`output/metadata/${file}?t=${Date.now()}`, { cache: "no-store" })
        .then(r => {
          if (!r.ok) throw new Error(file + " failed");
          return r.json();
        })
        .then(daily => ({ file, daily }))
    );

    const results = await Promise.all(requests);

    results.forEach(({ file, daily }) => {
      const dateMatch = file.match(/\d{4}-\d{2}-\d{2}/);
      const date = dateMatch ? dateMatch[0] : '';

      daily.forEach(p => {
        allPosts.push({
          date,
          text: p.tweet_text || "",
          images: p.images || [],
          url: p.tweet_url || "",
          hashtags: extractHashtags(p.tweet_text || ""),
          type: p.type || "",
          dateObj: new Date(date) // convert once for filtering
        });
      });

      loadedFiles.push(file);
    });

    allPosts.sort((a, b) => b.date.localeCompare(a.date));
    renderLimited(allPosts);
  } catch (err) {
    console.error("SPXVisuals load error:", err);
    document.getElementById("posts").innerHTML =
      "<p style='text-align:center'>‚ö†Ô∏è Data failed to load.</p>";
  }

  loadPostsBatch.loading = false;
}

function extractHashtags(text) {
  if (!text) return [];
  const tagMatches = text.match(/#[A-Za-z0-9_]+/g) || [];
  const cashMatches = text.match(/\$[A-Za-z0-9_]+/g) || [];
  return [...new Set([...tagMatches, ...cashMatches])];
}

function stripHashtags(text) {
  if (!text) return "";
  return text
    .replace(/#[A-Za-z0-9_]+/g, '')
    .replace(/\$[A-Za-z0-9_]+/g, '')
    .replace(/\s{2,}/g, ' ')
    .trim();
}

function todayLocalISO() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}

function normalizeDateInput(input) {
  const match = input.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (!match) return input;
  const [, mm, dd, yyyy] = match;
  return `${yyyy}-${mm}-${dd}`;
}

function renderPosts(posts) {
  const container = document.getElementById('posts');
  container.innerHTML = '';

  if (!posts.length) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'No charts match your filters üìâ';
    container.appendChild(empty);
    return;
  }

  posts.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';

    div.innerHTML = `
      ${post.url ? `<div class="tweet-link-container"><a href="${post.url}" target="_blank">See Post On ùïè</a></div>` : ''}
      <div class="post-date">${post.date}</div>
      <div class="post-text">${stripHashtags(post.text)}</div>
      <div class="hashtags">
        ${post.hashtags.map(t => `<a href="#">${t}</a>`).join('')}
      </div>
      ${post.images.map((i, idx) => {
        const eager = idx < 4;
        return `<img src="${i}" loading="${eager ? 'eager' : 'lazy'}" decoding="async" fetchpriority="${eager ? 'high' : 'low'}">`;
      }).join('')}
    `;

    div.querySelectorAll('.hashtags a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('search').value = a.textContent;
        applyFilters();
      });
    });

    container.appendChild(div);
  });

  waitForImages().then(() => requestAnimationFrame(() => requestAnimationFrame(applyMasonry)));
  enableImageZoom();
}

function renderLimited(posts) {
  renderPosts(posts);

  let sentinel = document.getElementById('scrollSentinel');
  if (!sentinel) {
    sentinel = document.createElement('div');
    sentinel.id = 'scrollSentinel';
    sentinel.style.height = '80px';
    sentinel.style.margin = '80px 0';
    document.body.appendChild(sentinel);
    observer.observe(sentinel);
  }

  sentinel.style.display = loadedFiles.length >= allFiles.length ? 'none' : 'block';
}

const filters = { today: false, week: false, month: false };

function waitForImages() {
  const imgs = document.querySelectorAll('#posts img');
  return Promise.all([...imgs].map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(res => { img.onload = img.onerror = res; });
  }));
}

function updateButtons() {
  todayBtn.classList.toggle('active', filters.today);
  weekBtn.classList.toggle('active', filters.week);
  monthBtn.classList.toggle('active', filters.month);

  const searchValue = document.getElementById('search').value;
  clearBtn.style.display =
    (filters.today || filters.week || filters.month || searchValue)
      ? 'inline-block'
      : 'none';
}

function applyFilters() {
  filtersActive = true;

  let input = normalizeDateInput(
    document.getElementById('search').value.toLowerCase()
  );

  let filtered = allPosts.filter(post =>
    post.hashtags.some(t => t.toLowerCase().includes(input)) ||
    post.date.includes(input)
  );

  const now = new Date();
  now.setHours(23,59,59,999);

  if (filters.today) {
    filtered = filtered.filter(p => p.date === todayLocalISO());
  } else if (filters.week) {
    // Sunday ‚Üí today
    const sunday = new Date(now);
    sunday.setDate(now.getDate() - now.getDay());
    sunday.setHours(0,0,0,0);
    filtered = filtered.filter(p => p.dateObj >= sunday && p.dateObj <= now);
  } else if (filters.month) {
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    filtered = filtered.filter(p => p.dateObj >= firstDay && p.dateObj <= now);
  }

  renderPosts(filtered);
  updateButtons();

  observer.disconnect(); // pause infinite scroll
}

document.getElementById('search').addEventListener('input', applyFilters);

const todayBtn = document.getElementById('todayFilter');
const weekBtn = document.getElementById('weekFilter');
const monthBtn = document.getElementById('monthFilter');
const clearBtn = document.getElementById('clearSearch');

todayBtn.onclick = () => {
  filters.today = !filters.today;
  filters.week = filters.month = false;
  applyFilters();
};

weekBtn.onclick = () => {
  filters.week = !filters.week;
  filters.today = filters.month = false;
  applyFilters();
};

monthBtn.onclick = () => {
  filters.month = !filters.month;
  filters.today = filters.week = false;
  applyFilters();
};

clearBtn.onclick = () => {
  document.getElementById('search').value = '';
  filters.today = filters.week = filters.month = false;
  filtersActive = false;
  renderLimited(allPosts);
  observer.observe(document.getElementById('scrollSentinel'));
  updateButtons();
};

function applyMasonry() {
  const container = document.getElementById('posts');
  const items = [...container.children];
  if (!items.length) return;

  const cols = window.innerWidth < 768 ? 1 : 2;
  const gap = 32;
  const colHeights = Array(cols).fill(0);
  const colWidth = (container.clientWidth - gap) / cols;

  container.style.position = 'relative';

  items.forEach(item => {
    item.style.position = 'absolute';
    item.style.width = colWidth + 'px';

    const minCol = colHeights.indexOf(Math.min(...colHeights));
    let x = minCol * (colWidth + gap);
    if (cols === 1) x = (container.clientWidth - colWidth) / 2;
    const y = colHeights[minCol];

    item.style.transform = `translate(${x}px, ${y}px)`;
    colHeights[minCol] += item.offsetHeight + gap;
  });

  container.style.height = Math.max(...colHeights) + 'px';
}

window.addEventListener('resize', () => {
  requestAnimationFrame(applyMasonry);
});

document.getElementById('posts').addEventListener('load', e => {
  if (e.target.tagName === 'IMG') {
    requestAnimationFrame(() => requestAnimationFrame(applyMasonry));
  }
}, true);

function enableImageZoom() {
  document.querySelectorAll('#posts img').forEach(img => {
    img.addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      const big = document.createElement('img');
      big.src = img.src;
      modal.appendChild(big);
      document.body.appendChild(modal);
      modal.addEventListener('click', () => modal.remove());
    });
  });
}

// INITIAL LOAD
loadPostsBatch();
</script>

</body>
</html>
